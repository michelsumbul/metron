/*
 * Copyright 2018 The Apache Software Foundation.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.metron.rest.controller;

import com.fasterxml.jackson.databind.ObjectMapper;
import static org.apache.metron.rest.MetronRestConstants.TEST_PROFILE;
import org.apache.metron.rest.model.PcapRequest;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import org.apache.metron.rest.model.PcapResponse;
import org.apache.metron.rest.service.PcapQueryService;
import org.apache.metron.rest.service.impl.PcapQueryServiceImpl;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mockito;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.core.env.Environment;
import org.springframework.http.MediaType;
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.csrf;
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.httpBasic;
import static org.springframework.security.test.web.servlet.setup.SecurityMockMvcConfigurers.springSecurity;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.content;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;
import org.springframework.web.context.WebApplicationContext;

/**
 *
 * @author msumbul
 */
@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@ActiveProfiles(TEST_PROFILE)
public class PcapQueryControllerIntegrationTest {

    @Autowired
    private Environment environment;

    @Autowired
    private WebApplicationContext wac;

    private MockMvc mockMvc;

    private String pcapUrl = "/api/v1/pcap/pcapqueryfilterasync";
    private String user = "user";
    private String password = "password";

    private String metronVersion;
    private PcapRequest pcapRequest;
    private PcapResponse pcapResponse;
    private ObjectMapper jsonMapper;
    private String expectedContent;
    private PcapQueryServiceImpl pcapQueryServiceImpl;
    
    @Autowired
    private PcapQueryService pcapQueryServiceImpl2;
    private PcapQueryController pcapQueryController;

    @Before
    public void setup() throws Exception {
        this.metronVersion = this.environment.getProperty("metron.version");
        this.mockMvc = MockMvcBuilders.webAppContextSetup(this.wac).apply(springSecurity()).build();

        pcapQueryController = mock(PcapQueryController.class);
        pcapQueryServiceImpl2 = mock(PcapQueryServiceImpl.class);
        pcapResponse = new PcapResponse();
        pcapRequest = new PcapRequest();
        pcapRequest.setSrcIp("192.168.1.2");
        pcapRequest.setSrcPort("33029");
        pcapRequest.setDstIp("192.168.1.1");
        pcapRequest.setDstPort("22");
        pcapRequest.setStartTime(1l);
        pcapRequest.setEndTime(1524137395328l);
        pcapRequest.setProtocol("6");
        pcapRequest.setPacketFilter("false");

        pcapQueryServiceImpl = new PcapQueryServiceImpl(pcapRequest);

        PcapResponse pcapResp = new PcapResponse();
        pcapResp.setIdQuery("application_1522924938685_0074");
        pcapResp.setStatus("FINISHED");
        pcapResp.setPercentage("100.0");
        pcapResp.setJson("{\"version\":\"0\",\"creator\":\"wireshark/1.10.14\",\"time\":\"Tue Apr 17 16:06:25 2018\",\"capture_file\":\"/tmp/1811638323837508/pcap-data-100+0001.pcap\",\"packets\":[{\"protos\":[{\"name\":\"geninfo\",\"pos\":\"0\",\"showname\":\"General information\",\"size\":\"66\",\"hide\":null,\"fields\":[{\"name\":\"num\",\"pos\":\"0\",\"showname\":\"Number\",\"size\":\"66\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"len\",\"pos\":\"0\",\"showname\":\"Frame Length\",\"size\":\"66\",\"value\":\"42\",\"show\":\"66\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"caplen\",\"pos\":\"0\",\"showname\":\"Captured Length\",\"size\":\"66\",\"value\":\"42\",\"show\":\"66\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"timestamp\",\"pos\":\"0\",\"showname\":\"Captured Time\",\"size\":\"66\",\"value\":\"1522244608.113998000\",\"show\":\"Mar 28, 2018 13:43:28.113998000 UTC\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}]},{\"name\":\"frame\",\"pos\":\"0\",\"showname\":\"Frame 1: 66 bytes on wire (528 bits), 66 bytes captured (528 bits)\",\"size\":\"66\",\"hide\":null,\"fields\":[{\"name\":\"frame.encap_type\",\"pos\":\"0\",\"showname\":\"Encapsulation type: Ethernet (1)\",\"size\":\"0\",\"value\":null,\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time\",\"pos\":\"0\",\"showname\":\"Arrival Time: Mar 28, 2018 13:43:28.113998000 UTC\",\"size\":\"0\",\"value\":null,\"show\":\"\\\"Mar 28, 2018 13:43:28.113998000 UTC\\\"\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.offset_shift\",\"pos\":\"0\",\"showname\":\"Time shift for this packet: 0.000000000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"0.000000000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time_epoch\",\"pos\":\"0\",\"showname\":\"Epoch Time: 1522244608.113998000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"1522244608.113998000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time_delta\",\"pos\":\"0\",\"showname\":\"Time delta from previous captured frame: 0.000000000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"0.000000000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time_delta_displayed\",\"pos\":\"0\",\"showname\":\"Time delta from previous displayed frame: 0.000000000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"0.000000000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time_relative\",\"pos\":\"0\",\"showname\":\"Time since reference or first frame: 0.000000000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"0.000000000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.number\",\"pos\":\"0\",\"showname\":\"Frame Number: 1\",\"size\":\"0\",\"value\":null,\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.len\",\"pos\":\"0\",\"showname\":\"Frame Length: 66 bytes (528 bits)\",\"size\":\"0\",\"value\":null,\"show\":\"66\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.cap_len\",\"pos\":\"0\",\"showname\":\"Capture Length: 66 bytes (528 bits)\",\"size\":\"0\",\"value\":null,\"show\":\"66\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.marked\",\"pos\":\"0\",\"showname\":\"Frame is marked: False\",\"size\":\"0\",\"value\":null,\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.ignored\",\"pos\":\"0\",\"showname\":\"Frame is ignored: False\",\"size\":\"0\",\"value\":null,\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.protocols\",\"pos\":\"0\",\"showname\":\"Protocols in frame: eth:ip:tcp\",\"size\":\"0\",\"value\":null,\"show\":\"eth:ip:tcp\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}]},{\"name\":\"eth\",\"pos\":\"0\",\"showname\":\"Ethernet II, Src: Cisco_5b:e8:c1 (84:78:ac:5b:e8:c1), Dst: fa:16:3e:04:cd:37 (fa:16:3e:04:cd:37)\",\"size\":\"14\",\"hide\":null,\"fields\":[{\"name\":\"eth.dst\",\"pos\":\"0\",\"showname\":\"Destination: fa:16:3e:04:cd:37 (fa:16:3e:04:cd:37)\",\"size\":\"6\",\"value\":\"fa163e04cd37\",\"show\":\"fa:16:3e:04:cd:37\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"eth.addr\",\"pos\":\"0\",\"showname\":\"Address: fa:16:3e:04:cd:37 (fa:16:3e:04:cd:37)\",\"size\":\"6\",\"value\":\"fa163e04cd37\",\"show\":\"fa:16:3e:04:cd:37\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"eth.lg\",\"pos\":\"0\",\"showname\":\".... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)\",\"size\":\"3\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":\"fa163e\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"eth.ig\",\"pos\":\"0\",\"showname\":\".... ...0 .... .... .... .... = IG bit: Individual address (unicast)\",\"size\":\"3\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"fa163e\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"eth.src\",\"pos\":\"6\",\"showname\":\"Source: Cisco_5b:e8:c1 (84:78:ac:5b:e8:c1)\",\"size\":\"6\",\"value\":\"8478ac5be8c1\",\"show\":\"84:78:ac:5b:e8:c1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"eth.addr\",\"pos\":\"6\",\"showname\":\"Address: Cisco_5b:e8:c1 (84:78:ac:5b:e8:c1)\",\"size\":\"6\",\"value\":\"8478ac5be8c1\",\"show\":\"84:78:ac:5b:e8:c1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"eth.lg\",\"pos\":\"6\",\"showname\":\".... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)\",\"size\":\"3\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"8478ac\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"eth.ig\",\"pos\":\"6\",\"showname\":\".... ...0 .... .... .... .... = IG bit: Individual address (unicast)\",\"size\":\"3\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"8478ac\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"eth.type\",\"pos\":\"12\",\"showname\":\"Type: IP (0x0800)\",\"size\":\"2\",\"value\":\"0800\",\"show\":\"2048\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}]},{\"name\":\"ip\",\"pos\":\"14\",\"showname\":\"Internet Protocol Version 4, Src: 10.200.10.172 (10.200.10.172), Dst: 172.26.215.106 (172.26.215.106)\",\"size\":\"20\",\"hide\":null,\"fields\":[{\"name\":\"ip.version\",\"pos\":\"14\",\"showname\":\"Version: 4\",\"size\":\"1\",\"value\":\"45\",\"show\":\"4\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.hdr_len\",\"pos\":\"14\",\"showname\":\"Header length: 20 bytes\",\"size\":\"1\",\"value\":\"45\",\"show\":\"20\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.dsfield\",\"pos\":\"15\",\"showname\":\"Differentiated Services Field: 0x00 (DSCP 0x00: Default; ECN: 0x00: Not-ECT (Not ECN-Capable Transport))\",\"size\":\"1\",\"value\":\"00\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"ip.dsfield.dscp\",\"pos\":\"15\",\"showname\":\"0000 00.. = Differentiated Services Codepoint: Default (0x00)\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"00\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.dsfield.ecn\",\"pos\":\"15\",\"showname\":\".... ..00 = Explicit Congestion Notification: Not-ECT (Not ECN-Capable Transport) (0x00)\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"00\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"ip.len\",\"pos\":\"16\",\"showname\":\"Total Length: 52\",\"size\":\"2\",\"value\":\"0034\",\"show\":\"52\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.id\",\"pos\":\"18\",\"showname\":\"Identification: 0x0000 (0)\",\"size\":\"2\",\"value\":\"0000\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.flags\",\"pos\":\"20\",\"showname\":\"Flags: 0x02 (Don't Fragment)\",\"size\":\"1\",\"value\":\"40\",\"show\":\"2\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"ip.flags.rb\",\"pos\":\"20\",\"showname\":\"0... .... = Reserved bit: Not set\",\"size\":\"1\",\"value\":\"40\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.flags.df\",\"pos\":\"20\",\"showname\":\".1.. .... = Don't fragment: Set\",\"size\":\"1\",\"value\":\"40\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.flags.mf\",\"pos\":\"20\",\"showname\":\"..0. .... = More fragments: Not set\",\"size\":\"1\",\"value\":\"40\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"ip.frag_offset\",\"pos\":\"20\",\"showname\":\"Fragment offset: 0\",\"size\":\"2\",\"value\":\"4000\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.ttl\",\"pos\":\"22\",\"showname\":\"Time to live: 62\",\"size\":\"1\",\"value\":\"3e\",\"show\":\"62\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.proto\",\"pos\":\"23\",\"showname\":\"Protocol: TCP (6)\",\"size\":\"1\",\"value\":\"06\",\"show\":\"6\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.checksum\",\"pos\":\"24\",\"showname\":\"Header checksum: 0xa3cb [validation disabled]\",\"size\":\"2\",\"value\":\"a3cb\",\"show\":\"41931\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"ip.checksum_good\",\"pos\":\"24\",\"showname\":\"Good: False\",\"size\":\"2\",\"value\":\"a3cb\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.checksum_bad\",\"pos\":\"24\",\"showname\":\"Bad: False\",\"size\":\"2\",\"value\":\"a3cb\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"ip.src\",\"pos\":\"26\",\"showname\":\"Source: 10.200.10.172 (10.200.10.172)\",\"size\":\"4\",\"value\":\"0ac80aac\",\"show\":\"10.200.10.172\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.addr\",\"pos\":\"26\",\"showname\":\"Source or Destination Address: 10.200.10.172 (10.200.10.172)\",\"size\":\"4\",\"value\":\"0ac80aac\",\"show\":\"10.200.10.172\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.src_host\",\"pos\":\"26\",\"showname\":\"Source Host: 10.200.10.172\",\"size\":\"4\",\"value\":\"0ac80aac\",\"show\":\"10.200.10.172\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.host\",\"pos\":\"26\",\"showname\":\"Source or Destination Host: 10.200.10.172\",\"size\":\"4\",\"value\":\"0ac80aac\",\"show\":\"10.200.10.172\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.dst\",\"pos\":\"30\",\"showname\":\"Destination: 172.26.215.106 (172.26.215.106)\",\"size\":\"4\",\"value\":\"ac1ad76a\",\"show\":\"172.26.215.106\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.addr\",\"pos\":\"30\",\"showname\":\"Source or Destination Address: 172.26.215.106 (172.26.215.106)\",\"size\":\"4\",\"value\":\"ac1ad76a\",\"show\":\"172.26.215.106\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.dst_host\",\"pos\":\"30\",\"showname\":\"Destination Host: 172.26.215.106\",\"size\":\"4\",\"value\":\"ac1ad76a\",\"show\":\"172.26.215.106\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.host\",\"pos\":\"30\",\"showname\":\"Source or Destination Host: 172.26.215.106\",\"size\":\"4\",\"value\":\"ac1ad76a\",\"show\":\"172.26.215.106\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null}]},{\"name\":\"tcp\",\"pos\":\"34\",\"showname\":\"Transmission Control Protocol, Src Port: 52834 (52834), Dst Port: ssh (22), Seq: 1, Ack: 1, Len: 0\",\"size\":\"32\",\"hide\":null,\"fields\":[{\"name\":\"tcp.srcport\",\"pos\":\"34\",\"showname\":\"Source port: 52834 (52834)\",\"size\":\"2\",\"value\":\"ce62\",\"show\":\"52834\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.dstport\",\"pos\":\"36\",\"showname\":\"Destination port: ssh (22)\",\"size\":\"2\",\"value\":\"0016\",\"show\":\"22\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.port\",\"pos\":\"34\",\"showname\":\"Source or Destination Port: 52834\",\"size\":\"2\",\"value\":\"ce62\",\"show\":\"52834\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"tcp.port\",\"pos\":\"36\",\"showname\":\"Source or Destination Port: 22\",\"size\":\"2\",\"value\":\"0016\",\"show\":\"22\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"tcp.stream\",\"pos\":\"34\",\"showname\":\"Stream index: 0\",\"size\":\"0\",\"value\":null,\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.len\",\"pos\":\"46\",\"showname\":\"TCP Segment Len: 0\",\"size\":\"1\",\"value\":\"80\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"tcp.seq\",\"pos\":\"38\",\"showname\":\"Sequence number: 1    (relative sequence number)\",\"size\":\"4\",\"value\":\"3e7a345c\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.ack\",\"pos\":\"42\",\"showname\":\"Acknowledgment number: 1    (relative ack number)\",\"size\":\"4\",\"value\":\"342f6f2e\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.hdr_len\",\"pos\":\"46\",\"showname\":\"Header length: 32 bytes\",\"size\":\"1\",\"value\":\"80\",\"show\":\"32\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags\",\"pos\":\"46\",\"showname\":\"Flags: 0x010 (ACK)\",\"size\":\"2\",\"value\":\"10\",\"show\":\"16\",\"unmaskedvalue\":\"8010\",\"hide\":null,\"fields\":[{\"name\":\"tcp.flags.res\",\"pos\":\"46\",\"showname\":\"000. .... .... = Reserved: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"80\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.ns\",\"pos\":\"46\",\"showname\":\"...0 .... .... = Nonce: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"80\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.cwr\",\"pos\":\"47\",\"showname\":\".... 0... .... = Congestion Window Reduced (CWR): Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.ecn\",\"pos\":\"47\",\"showname\":\".... .0.. .... = ECN-Echo: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.urg\",\"pos\":\"47\",\"showname\":\".... ..0. .... = Urgent: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.ack\",\"pos\":\"47\",\"showname\":\".... ...1 .... = Acknowledgment: Set\",\"size\":\"1\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.push\",\"pos\":\"47\",\"showname\":\".... .... 0... = Push: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.reset\",\"pos\":\"47\",\"showname\":\".... .... .0.. = Reset: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.syn\",\"pos\":\"47\",\"showname\":\".... .... ..0. = Syn: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.fin\",\"pos\":\"47\",\"showname\":\".... .... ...0 = Fin: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"tcp.window_size_value\",\"pos\":\"48\",\"showname\":\"Window size value: 4094\",\"size\":\"2\",\"value\":\"0ffe\",\"show\":\"4094\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.window_size\",\"pos\":\"48\",\"showname\":\"Calculated window size: 4094\",\"size\":\"2\",\"value\":\"0ffe\",\"show\":\"4094\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.window_size_scalefactor\",\"pos\":\"48\",\"showname\":\"Window size scaling factor: -1 (unknown)\",\"size\":\"2\",\"value\":\"0ffe\",\"show\":\"-1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.checksum\",\"pos\":\"50\",\"showname\":\"Checksum: 0xf22c [validation disabled]\",\"size\":\"2\",\"value\":\"f22c\",\"show\":\"61996\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.checksum_good\",\"pos\":\"50\",\"showname\":\"Good Checksum: False\",\"size\":\"2\",\"value\":\"f22c\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.checksum_bad\",\"pos\":\"50\",\"showname\":\"Bad Checksum: False\",\"size\":\"2\",\"value\":\"f22c\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"tcp.options\",\"pos\":\"54\",\"showname\":\"Options: (12 bytes), No-Operation (NOP), No-Operation (NOP), Timestamps\",\"size\":\"12\",\"value\":\"0101080a1ec843d604758fd9\",\"show\":\"01:01:08:0a:1e:c8:43:d6:04:75:8f:d9\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"\",\"pos\":\"54\",\"showname\":null,\"size\":\"1\",\"value\":\"01\",\"show\":\"No-Operation (NOP)\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.options.type\",\"pos\":\"54\",\"showname\":\"Type: 1\",\"size\":\"1\",\"value\":\"01\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.options.type.copy\",\"pos\":\"54\",\"showname\":\"0... .... = Copy on fragmentation: No\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.type.class\",\"pos\":\"54\",\"showname\":\".00. .... = Class: Control (0)\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.type.number\",\"pos\":\"54\",\"showname\":\"...0 0001 = Number: No-Operation (NOP) (1)\",\"size\":\"1\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null}],\"protos\":null},{\"name\":\"\",\"pos\":\"55\",\"showname\":null,\"size\":\"1\",\"value\":\"01\",\"show\":\"No-Operation (NOP)\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.options.type\",\"pos\":\"55\",\"showname\":\"Type: 1\",\"size\":\"1\",\"value\":\"01\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.options.type.copy\",\"pos\":\"55\",\"showname\":\"0... .... = Copy on fragmentation: No\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.type.class\",\"pos\":\"55\",\"showname\":\".00. .... = Class: Control (0)\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.type.number\",\"pos\":\"55\",\"showname\":\"...0 0001 = Number: No-Operation (NOP) (1)\",\"size\":\"1\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null}],\"protos\":null},{\"name\":\"\",\"pos\":\"56\",\"showname\":null,\"size\":\"10\",\"value\":\"080a1ec843d604758fd9\",\"show\":\"Timestamps: TSval 516441046, TSecr 74813401\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.option_kind\",\"pos\":\"56\",\"showname\":\"Kind: Timestamp (8)\",\"size\":\"1\",\"value\":\"08\",\"show\":\"8\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.option_len\",\"pos\":\"57\",\"showname\":\"Length: 10\",\"size\":\"1\",\"value\":\"0a\",\"show\":\"10\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.timestamp.tsval\",\"pos\":\"58\",\"showname\":\"Timestamp value: 516441046\",\"size\":\"4\",\"value\":\"1ec843d6\",\"show\":\"516441046\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.timestamp.tsecr\",\"pos\":\"62\",\"showname\":\"Timestamp echo reply: 74813401\",\"size\":\"4\",\"value\":\"04758fd9\",\"show\":\"74813401\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null}],\"protos\":null}]}]}]}]}");

      //  pcapQueryServiceImpl.setPcapResponse(pcapResp);

        jsonMapper = new ObjectMapper();
    }

    @Test
    public void testSecurity() throws Exception {
        this.mockMvc.perform(get(pcapUrl))
                .andExpect(status().isUnauthorized());

        this.mockMvc.perform(get(pcapUrl + "/submit"))
                .andExpect(status().isUnauthorized());
        this.mockMvc.perform(get(pcapUrl + "/status"))
                .andExpect(status().isUnauthorized());
        this.mockMvc.perform(get(pcapUrl + "/resultJson"))
                .andExpect(status().isUnauthorized());
        this.mockMvc.perform(get(pcapUrl + "/clear"))
                .andExpect(status().isUnauthorized());
        this.mockMvc.perform(get(pcapUrl + "/listquery"))
                .andExpect(status().isUnauthorized());

    }

    @Test
    public void testClear() throws Exception {
        this.mockMvc.perform(post(pcapUrl + "/clear?idQuery=application_1522924938685_0074").with(httpBasic(user, password)).with(csrf()).contentType(MediaType.parseMediaType("application/json;charset=UTF-8"))/*.content("{\"idQuery\":\"application_1522924938685_0074\"}")*/)
                .andExpect(status().isNotFound());

    }

    @Test
    public void testSubmit() throws Exception {
        when(pcapQueryServiceImpl2.getPcapsLinuxProcessAsync()).thenReturn("job_1522924938685_0074");
        when(pcapQueryServiceImpl2.updateYarnJobStatusRest()).thenReturn(0);
        
        pcapResponse.setIdQuery("application_1522924938685_0074");
        pcapResponse.setStatus("ACCEPTED");
        pcapResponse.setPercentage("0.0");
        pcapResponse.setJson(null);

        expectedContent = jsonMapper.writeValueAsString(pcapResponse);
        this.mockMvc.perform(post(pcapUrl + "/submit").with(httpBasic(user, password)).contentType(MediaType.parseMediaType("application/json;charset=UTF-8")).content(jsonMapper.writeValueAsString(pcapRequest)))
                .andExpect(status().isCreated())
                .andExpect(content().json(expectedContent));
    }

    
    @Test
    public void testGetStatus() throws Exception {

        when(pcapQueryController.findQueryInList("application_1522924938685_0074")).thenReturn(pcapQueryServiceImpl);
        
        //Test get Status/progression of the job post request
        pcapResponse.setIdQuery("application_1522924938685_0074");
        pcapResponse.setStatus("FINISHED");
        pcapResponse.setPercentage("100.0");
        pcapResponse.setJson(null);
        expectedContent = jsonMapper.writeValueAsString(pcapResponse);
        this.mockMvc.perform(post(pcapUrl + "/status?idQuery=application_1522924938685_0074").with(httpBasic(user, password)).contentType(MediaType.parseMediaType("application/json;charset=UTF-8")))
                .andExpect(status().isOk())
                .andExpect(content().json(expectedContent));
    }
   
    @Test
    public void testGetResult() throws Exception {
        //Test get result json of query post request
         when(pcapQueryController.findQueryInList("application_1522924938685_0074")).thenReturn(pcapQueryServiceImpl);
         when(pcapQueryServiceImpl2.updateYarnJobStatusRest()).thenReturn(0);
        pcapResponse.setIdQuery("application_1522924938685_0074");
        pcapResponse.setStatus("FINISHED");
        pcapResponse.setPercentage("100.0");
        pcapResponse.setJson("{\"version\":\"0\",\"creator\":\"wireshark/1.10.14\",\"time\":\"Tue Apr 17 16:06:25 2018\",\"capture_file\":\"/tmp/1811638323837508/pcap-data-100+0001.pcap\",\"packets\":[{\"protos\":[{\"name\":\"geninfo\",\"pos\":\"0\",\"showname\":\"General information\",\"size\":\"66\",\"hide\":null,\"fields\":[{\"name\":\"num\",\"pos\":\"0\",\"showname\":\"Number\",\"size\":\"66\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"len\",\"pos\":\"0\",\"showname\":\"Frame Length\",\"size\":\"66\",\"value\":\"42\",\"show\":\"66\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"caplen\",\"pos\":\"0\",\"showname\":\"Captured Length\",\"size\":\"66\",\"value\":\"42\",\"show\":\"66\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"timestamp\",\"pos\":\"0\",\"showname\":\"Captured Time\",\"size\":\"66\",\"value\":\"1522244608.113998000\",\"show\":\"Mar 28, 2018 13:43:28.113998000 UTC\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}]},{\"name\":\"frame\",\"pos\":\"0\",\"showname\":\"Frame 1: 66 bytes on wire (528 bits), 66 bytes captured (528 bits)\",\"size\":\"66\",\"hide\":null,\"fields\":[{\"name\":\"frame.encap_type\",\"pos\":\"0\",\"showname\":\"Encapsulation type: Ethernet (1)\",\"size\":\"0\",\"value\":null,\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time\",\"pos\":\"0\",\"showname\":\"Arrival Time: Mar 28, 2018 13:43:28.113998000 UTC\",\"size\":\"0\",\"value\":null,\"show\":\"\\\"Mar 28, 2018 13:43:28.113998000 UTC\\\"\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.offset_shift\",\"pos\":\"0\",\"showname\":\"Time shift for this packet: 0.000000000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"0.000000000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time_epoch\",\"pos\":\"0\",\"showname\":\"Epoch Time: 1522244608.113998000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"1522244608.113998000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time_delta\",\"pos\":\"0\",\"showname\":\"Time delta from previous captured frame: 0.000000000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"0.000000000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time_delta_displayed\",\"pos\":\"0\",\"showname\":\"Time delta from previous displayed frame: 0.000000000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"0.000000000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.time_relative\",\"pos\":\"0\",\"showname\":\"Time since reference or first frame: 0.000000000 seconds\",\"size\":\"0\",\"value\":null,\"show\":\"0.000000000\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.number\",\"pos\":\"0\",\"showname\":\"Frame Number: 1\",\"size\":\"0\",\"value\":null,\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.len\",\"pos\":\"0\",\"showname\":\"Frame Length: 66 bytes (528 bits)\",\"size\":\"0\",\"value\":null,\"show\":\"66\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.cap_len\",\"pos\":\"0\",\"showname\":\"Capture Length: 66 bytes (528 bits)\",\"size\":\"0\",\"value\":null,\"show\":\"66\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.marked\",\"pos\":\"0\",\"showname\":\"Frame is marked: False\",\"size\":\"0\",\"value\":null,\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.ignored\",\"pos\":\"0\",\"showname\":\"Frame is ignored: False\",\"size\":\"0\",\"value\":null,\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"frame.protocols\",\"pos\":\"0\",\"showname\":\"Protocols in frame: eth:ip:tcp\",\"size\":\"0\",\"value\":null,\"show\":\"eth:ip:tcp\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}]},{\"name\":\"eth\",\"pos\":\"0\",\"showname\":\"Ethernet II, Src: Cisco_5b:e8:c1 (84:78:ac:5b:e8:c1), Dst: fa:16:3e:04:cd:37 (fa:16:3e:04:cd:37)\",\"size\":\"14\",\"hide\":null,\"fields\":[{\"name\":\"eth.dst\",\"pos\":\"0\",\"showname\":\"Destination: fa:16:3e:04:cd:37 (fa:16:3e:04:cd:37)\",\"size\":\"6\",\"value\":\"fa163e04cd37\",\"show\":\"fa:16:3e:04:cd:37\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"eth.addr\",\"pos\":\"0\",\"showname\":\"Address: fa:16:3e:04:cd:37 (fa:16:3e:04:cd:37)\",\"size\":\"6\",\"value\":\"fa163e04cd37\",\"show\":\"fa:16:3e:04:cd:37\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"eth.lg\",\"pos\":\"0\",\"showname\":\".... ..1. .... .... .... .... = LG bit: Locally administered address (this is NOT the factory default)\",\"size\":\"3\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":\"fa163e\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"eth.ig\",\"pos\":\"0\",\"showname\":\".... ...0 .... .... .... .... = IG bit: Individual address (unicast)\",\"size\":\"3\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"fa163e\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"eth.src\",\"pos\":\"6\",\"showname\":\"Source: Cisco_5b:e8:c1 (84:78:ac:5b:e8:c1)\",\"size\":\"6\",\"value\":\"8478ac5be8c1\",\"show\":\"84:78:ac:5b:e8:c1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"eth.addr\",\"pos\":\"6\",\"showname\":\"Address: Cisco_5b:e8:c1 (84:78:ac:5b:e8:c1)\",\"size\":\"6\",\"value\":\"8478ac5be8c1\",\"show\":\"84:78:ac:5b:e8:c1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"eth.lg\",\"pos\":\"6\",\"showname\":\".... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)\",\"size\":\"3\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"8478ac\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"eth.ig\",\"pos\":\"6\",\"showname\":\".... ...0 .... .... .... .... = IG bit: Individual address (unicast)\",\"size\":\"3\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"8478ac\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"eth.type\",\"pos\":\"12\",\"showname\":\"Type: IP (0x0800)\",\"size\":\"2\",\"value\":\"0800\",\"show\":\"2048\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}]},{\"name\":\"ip\",\"pos\":\"14\",\"showname\":\"Internet Protocol Version 4, Src: 10.200.10.172 (10.200.10.172), Dst: 172.26.215.106 (172.26.215.106)\",\"size\":\"20\",\"hide\":null,\"fields\":[{\"name\":\"ip.version\",\"pos\":\"14\",\"showname\":\"Version: 4\",\"size\":\"1\",\"value\":\"45\",\"show\":\"4\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.hdr_len\",\"pos\":\"14\",\"showname\":\"Header length: 20 bytes\",\"size\":\"1\",\"value\":\"45\",\"show\":\"20\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.dsfield\",\"pos\":\"15\",\"showname\":\"Differentiated Services Field: 0x00 (DSCP 0x00: Default; ECN: 0x00: Not-ECT (Not ECN-Capable Transport))\",\"size\":\"1\",\"value\":\"00\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"ip.dsfield.dscp\",\"pos\":\"15\",\"showname\":\"0000 00.. = Differentiated Services Codepoint: Default (0x00)\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"00\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.dsfield.ecn\",\"pos\":\"15\",\"showname\":\".... ..00 = Explicit Congestion Notification: Not-ECT (Not ECN-Capable Transport) (0x00)\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"00\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"ip.len\",\"pos\":\"16\",\"showname\":\"Total Length: 52\",\"size\":\"2\",\"value\":\"0034\",\"show\":\"52\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.id\",\"pos\":\"18\",\"showname\":\"Identification: 0x0000 (0)\",\"size\":\"2\",\"value\":\"0000\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.flags\",\"pos\":\"20\",\"showname\":\"Flags: 0x02 (Don't Fragment)\",\"size\":\"1\",\"value\":\"40\",\"show\":\"2\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"ip.flags.rb\",\"pos\":\"20\",\"showname\":\"0... .... = Reserved bit: Not set\",\"size\":\"1\",\"value\":\"40\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.flags.df\",\"pos\":\"20\",\"showname\":\".1.. .... = Don't fragment: Set\",\"size\":\"1\",\"value\":\"40\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.flags.mf\",\"pos\":\"20\",\"showname\":\"..0. .... = More fragments: Not set\",\"size\":\"1\",\"value\":\"40\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"ip.frag_offset\",\"pos\":\"20\",\"showname\":\"Fragment offset: 0\",\"size\":\"2\",\"value\":\"4000\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.ttl\",\"pos\":\"22\",\"showname\":\"Time to live: 62\",\"size\":\"1\",\"value\":\"3e\",\"show\":\"62\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.proto\",\"pos\":\"23\",\"showname\":\"Protocol: TCP (6)\",\"size\":\"1\",\"value\":\"06\",\"show\":\"6\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.checksum\",\"pos\":\"24\",\"showname\":\"Header checksum: 0xa3cb [validation disabled]\",\"size\":\"2\",\"value\":\"a3cb\",\"show\":\"41931\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"ip.checksum_good\",\"pos\":\"24\",\"showname\":\"Good: False\",\"size\":\"2\",\"value\":\"a3cb\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.checksum_bad\",\"pos\":\"24\",\"showname\":\"Bad: False\",\"size\":\"2\",\"value\":\"a3cb\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"ip.src\",\"pos\":\"26\",\"showname\":\"Source: 10.200.10.172 (10.200.10.172)\",\"size\":\"4\",\"value\":\"0ac80aac\",\"show\":\"10.200.10.172\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.addr\",\"pos\":\"26\",\"showname\":\"Source or Destination Address: 10.200.10.172 (10.200.10.172)\",\"size\":\"4\",\"value\":\"0ac80aac\",\"show\":\"10.200.10.172\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.src_host\",\"pos\":\"26\",\"showname\":\"Source Host: 10.200.10.172\",\"size\":\"4\",\"value\":\"0ac80aac\",\"show\":\"10.200.10.172\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.host\",\"pos\":\"26\",\"showname\":\"Source or Destination Host: 10.200.10.172\",\"size\":\"4\",\"value\":\"0ac80aac\",\"show\":\"10.200.10.172\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.dst\",\"pos\":\"30\",\"showname\":\"Destination: 172.26.215.106 (172.26.215.106)\",\"size\":\"4\",\"value\":\"ac1ad76a\",\"show\":\"172.26.215.106\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"ip.addr\",\"pos\":\"30\",\"showname\":\"Source or Destination Address: 172.26.215.106 (172.26.215.106)\",\"size\":\"4\",\"value\":\"ac1ad76a\",\"show\":\"172.26.215.106\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.dst_host\",\"pos\":\"30\",\"showname\":\"Destination Host: 172.26.215.106\",\"size\":\"4\",\"value\":\"ac1ad76a\",\"show\":\"172.26.215.106\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"ip.host\",\"pos\":\"30\",\"showname\":\"Source or Destination Host: 172.26.215.106\",\"size\":\"4\",\"value\":\"ac1ad76a\",\"show\":\"172.26.215.106\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null}]},{\"name\":\"tcp\",\"pos\":\"34\",\"showname\":\"Transmission Control Protocol, Src Port: 52834 (52834), Dst Port: ssh (22), Seq: 1, Ack: 1, Len: 0\",\"size\":\"32\",\"hide\":null,\"fields\":[{\"name\":\"tcp.srcport\",\"pos\":\"34\",\"showname\":\"Source port: 52834 (52834)\",\"size\":\"2\",\"value\":\"ce62\",\"show\":\"52834\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.dstport\",\"pos\":\"36\",\"showname\":\"Destination port: ssh (22)\",\"size\":\"2\",\"value\":\"0016\",\"show\":\"22\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.port\",\"pos\":\"34\",\"showname\":\"Source or Destination Port: 52834\",\"size\":\"2\",\"value\":\"ce62\",\"show\":\"52834\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"tcp.port\",\"pos\":\"36\",\"showname\":\"Source or Destination Port: 22\",\"size\":\"2\",\"value\":\"0016\",\"show\":\"22\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"tcp.stream\",\"pos\":\"34\",\"showname\":\"Stream index: 0\",\"size\":\"0\",\"value\":null,\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.len\",\"pos\":\"46\",\"showname\":\"TCP Segment Len: 0\",\"size\":\"1\",\"value\":\"80\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":\"yes\",\"fields\":null,\"protos\":null},{\"name\":\"tcp.seq\",\"pos\":\"38\",\"showname\":\"Sequence number: 1    (relative sequence number)\",\"size\":\"4\",\"value\":\"3e7a345c\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.ack\",\"pos\":\"42\",\"showname\":\"Acknowledgment number: 1    (relative ack number)\",\"size\":\"4\",\"value\":\"342f6f2e\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.hdr_len\",\"pos\":\"46\",\"showname\":\"Header length: 32 bytes\",\"size\":\"1\",\"value\":\"80\",\"show\":\"32\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags\",\"pos\":\"46\",\"showname\":\"Flags: 0x010 (ACK)\",\"size\":\"2\",\"value\":\"10\",\"show\":\"16\",\"unmaskedvalue\":\"8010\",\"hide\":null,\"fields\":[{\"name\":\"tcp.flags.res\",\"pos\":\"46\",\"showname\":\"000. .... .... = Reserved: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"80\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.ns\",\"pos\":\"46\",\"showname\":\"...0 .... .... = Nonce: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"80\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.cwr\",\"pos\":\"47\",\"showname\":\".... 0... .... = Congestion Window Reduced (CWR): Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.ecn\",\"pos\":\"47\",\"showname\":\".... .0.. .... = ECN-Echo: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.urg\",\"pos\":\"47\",\"showname\":\".... ..0. .... = Urgent: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.ack\",\"pos\":\"47\",\"showname\":\".... ...1 .... = Acknowledgment: Set\",\"size\":\"1\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.push\",\"pos\":\"47\",\"showname\":\".... .... 0... = Push: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.reset\",\"pos\":\"47\",\"showname\":\".... .... .0.. = Reset: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.syn\",\"pos\":\"47\",\"showname\":\".... .... ..0. = Syn: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.flags.fin\",\"pos\":\"47\",\"showname\":\".... .... ...0 = Fin: Not set\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"10\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"tcp.window_size_value\",\"pos\":\"48\",\"showname\":\"Window size value: 4094\",\"size\":\"2\",\"value\":\"0ffe\",\"show\":\"4094\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.window_size\",\"pos\":\"48\",\"showname\":\"Calculated window size: 4094\",\"size\":\"2\",\"value\":\"0ffe\",\"show\":\"4094\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.window_size_scalefactor\",\"pos\":\"48\",\"showname\":\"Window size scaling factor: -1 (unknown)\",\"size\":\"2\",\"value\":\"0ffe\",\"show\":\"-1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.checksum\",\"pos\":\"50\",\"showname\":\"Checksum: 0xf22c [validation disabled]\",\"size\":\"2\",\"value\":\"f22c\",\"show\":\"61996\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.checksum_good\",\"pos\":\"50\",\"showname\":\"Good Checksum: False\",\"size\":\"2\",\"value\":\"f22c\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.checksum_bad\",\"pos\":\"50\",\"showname\":\"Bad Checksum: False\",\"size\":\"2\",\"value\":\"f22c\",\"show\":\"0\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null},{\"name\":\"tcp.options\",\"pos\":\"54\",\"showname\":\"Options: (12 bytes), No-Operation (NOP), No-Operation (NOP), Timestamps\",\"size\":\"12\",\"value\":\"0101080a1ec843d604758fd9\",\"show\":\"01:01:08:0a:1e:c8:43:d6:04:75:8f:d9\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"\",\"pos\":\"54\",\"showname\":null,\"size\":\"1\",\"value\":\"01\",\"show\":\"No-Operation (NOP)\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.options.type\",\"pos\":\"54\",\"showname\":\"Type: 1\",\"size\":\"1\",\"value\":\"01\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.options.type.copy\",\"pos\":\"54\",\"showname\":\"0... .... = Copy on fragmentation: No\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.type.class\",\"pos\":\"54\",\"showname\":\".00. .... = Class: Control (0)\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.type.number\",\"pos\":\"54\",\"showname\":\"...0 0001 = Number: No-Operation (NOP) (1)\",\"size\":\"1\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null}],\"protos\":null},{\"name\":\"\",\"pos\":\"55\",\"showname\":null,\"size\":\"1\",\"value\":\"01\",\"show\":\"No-Operation (NOP)\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.options.type\",\"pos\":\"55\",\"showname\":\"Type: 1\",\"size\":\"1\",\"value\":\"01\",\"show\":\"1\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.options.type.copy\",\"pos\":\"55\",\"showname\":\"0... .... = Copy on fragmentation: No\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.type.class\",\"pos\":\"55\",\"showname\":\".00. .... = Class: Control (0)\",\"size\":\"1\",\"value\":\"0\",\"show\":\"0\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.type.number\",\"pos\":\"55\",\"showname\":\"...0 0001 = Number: No-Operation (NOP) (1)\",\"size\":\"1\",\"value\":\"1\",\"show\":\"1\",\"unmaskedvalue\":\"01\",\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null}],\"protos\":null},{\"name\":\"\",\"pos\":\"56\",\"showname\":null,\"size\":\"10\",\"value\":\"080a1ec843d604758fd9\",\"show\":\"Timestamps: TSval 516441046, TSecr 74813401\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":[{\"name\":\"tcp.option_kind\",\"pos\":\"56\",\"showname\":\"Kind: Timestamp (8)\",\"size\":\"1\",\"value\":\"08\",\"show\":\"8\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.option_len\",\"pos\":\"57\",\"showname\":\"Length: 10\",\"size\":\"1\",\"value\":\"0a\",\"show\":\"10\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.timestamp.tsval\",\"pos\":\"58\",\"showname\":\"Timestamp value: 516441046\",\"size\":\"4\",\"value\":\"1ec843d6\",\"show\":\"516441046\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null},{\"name\":\"tcp.options.timestamp.tsecr\",\"pos\":\"62\",\"showname\":\"Timestamp echo reply: 74813401\",\"size\":\"4\",\"value\":\"04758fd9\",\"show\":\"74813401\",\"unmaskedvalue\":null,\"hide\":null,\"fields\":null,\"protos\":null}],\"protos\":null}],\"protos\":null}]}]}]}]}");
        expectedContent = jsonMapper.writeValueAsString(pcapResponse);
        this.mockMvc.perform(post(pcapUrl + "/resultJson?idQuery=application_1522924938685_0074").with(httpBasic(user, password)).contentType(MediaType.parseMediaType("application/json;charset=UTF-8")))
                .andExpect(status().isOk())
                .andExpect(content().json(expectedContent));
    }
     
    @Test
    public void testGetStatusJobDoesNotExist() throws Exception {
        //Test get status of job that doesnt exist
        this.mockMvc.perform(post(pcapUrl + "/status?idQuery=application_1522924938685_1111").with(httpBasic(user, password)).contentType(MediaType.parseMediaType("application/json;charset=UTF-8")))
                .andExpect(status().isNotFound());

    }

    @Test
    public void test() throws Exception {

        // this.mockMvc.perform(post(pcapUrl).with(httpBasic(user, password))).andExpect(status().isOk());
    }

}
